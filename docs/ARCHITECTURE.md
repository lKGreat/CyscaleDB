# CyscaleDB 系统架构

## 架构概览

```
┌─────────────────────────────────────────────────────────────────┐
│                        客户端层 (Client Layer)                   │
├─────────────────────────────────────────────────────────────────┤
│   CLI命令行工具              │           MySQL客户端              │
│   (CyscaleDB.Cli)           │        (mysql, MySQL Workbench)   │
└──────────────┬──────────────┴──────────────┬────────────────────┘
               │                              │
               │ 直接调用                      │ TCP/MySQL协议
               ▼                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                      接口层 (Interface Layer)                    │
├─────────────────────────────────────────────────────────────────┤
│                     MySQL协议处理器 (MySqlServer)                │
│   - 握手认证 (Handshake)                                         │
│   - 命令处理 (COM_QUERY, COM_QUIT, COM_PING)                     │
│   - 结果集编码 (PacketWriter)                                    │
└──────────────────────────────────┬──────────────────────────────┘
                                   │
                                   ▼
┌─────────────────────────────────────────────────────────────────┐
│                    查询处理层 (Query Processing Layer)           │
├─────────────────────────────────────────────────────────────────┤
│   ┌─────────────┐    ┌─────────────┐    ┌─────────────┐        │
│   │ Lexer       │───▶│ Parser      │───▶│ AST         │        │
│   │ 词法分析器   │    │ 语法分析器   │    │ 抽象语法树  │         │
│   └─────────────┘    └─────────────┘    └─────────────┘        │
└──────────────────────────────────┬──────────────────────────────┘
                                   │
                                   ▼
┌─────────────────────────────────────────────────────────────────┐
│                   执行引擎层 (Execution Engine Layer)            │
├─────────────────────────────────────────────────────────────────┤
│   ┌─────────────────────────────────────────────────────────┐   │
│   │                   Executor (查询执行器)                   │   │
│   └─────────────────────────────────────────────────────────┘   │
│                              │                                   │
│   ┌──────────────────────────┴──────────────────────────┐       │
│   │                    Operators (算子)                   │       │
│   │  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌─────────┐ │       │
│   │  │TableScan │ │IndexScan │ │ Filter   │ │ Project │ │       │
│   │  └──────────┘ └──────────┘ └──────────┘ └─────────┘ │       │
│   │  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌─────────┐ │       │
│   │  │  Join    │ │ GroupBy  │ │ OrderBy  │ │  Limit  │ │       │
│   │  └──────────┘ └──────────┘ └──────────┘ └─────────┘ │       │
│   │  ┌──────────┐ ┌──────────┐                          │       │
│   │  │ Distinct │ │  Alias   │                          │       │
│   │  └──────────┘ └──────────┘                          │       │
│   └─────────────────────────────────────────────────────┘       │
│                              │                                   │
│   ┌──────────────────────────┴──────────────────────────┐       │
│   │               Expression Evaluators                  │       │
│   │   (表达式求值: 比较、算术、逻辑、函数调用)              │       │
│   └─────────────────────────────────────────────────────┘       │
└──────────────────────────────────┬──────────────────────────────┘
                                   │
                                   ▼
┌─────────────────────────────────────────────────────────────────┐
│                   事务管理层 (Transaction Layer)                 │
├─────────────────────────────────────────────────────────────────┤
│   ┌─────────────┐    ┌─────────────┐    ┌─────────────┐        │
│   │Transaction  │    │LockManager  │    │WAL Log      │        │
│   │Manager      │───▶│ 锁管理器     │    │ 预写日志     │         │
│   │ 事务管理器   │    └─────────────┘    └─────────────┘        │
│   └─────────────┘                                               │
└──────────────────────────────────┬──────────────────────────────┘
                                   │
                                   ▼
┌─────────────────────────────────────────────────────────────────┐
│                    存储引擎层 (Storage Engine Layer)             │
├─────────────────────────────────────────────────────────────────┤
│   ┌─────────────────────────────────────────────────────────┐   │
│   │                   Catalog (元数据管理)                    │   │
│   │   - DatabaseInfo (数据库信息)                             │   │
│   │   - TableSchema (表结构)                                  │   │
│   │   - ColumnDefinition (列定义)                             │   │
│   └─────────────────────────────────────────────────────────┘   │
│                              │                                   │
│   ┌──────────────────────────┴──────────────────────────┐       │
│   │                     Table (表)                       │       │
│   │   - InsertRow / UpdateRow / DeleteRow                │       │
│   │   - ScanTable                                        │       │
│   └─────────────────────────────────────────────────────┘       │
│                              │                                   │
│   ┌──────────────────────────┴──────────────────────────┐       │
│   │                PageManager (页面管理器)               │       │
│   │   - 页的分配与回收                                    │       │
│   │   - 行的插入与删除                                    │       │
│   └─────────────────────────────────────────────────────┘       │
│                              │                                   │
│   ┌──────────────────────────┴──────────────────────────┐       │
│   │                BufferPool (缓冲池)                    │       │
│   │   - LRU 页面缓存                                      │       │
│   │   - 脏页管理                                          │       │
│   └─────────────────────────────────────────────────────┘       │
│                              │                                   │
│   ┌──────────────────────────┴──────────────────────────┐       │
│   │                   File I/O                           │       │
│   │   - .cdb 数据文件                                    │       │
│   │   - .idx / .hidx 索引文件                            │       │
│   │   - catalog.meta 元数据文件                          │       │
│   │   - .wal 日志文件                                    │       │
│   │   - checkpoint.meta 检查点文件                       │       │
│   └─────────────────────────────────────────────────────┘       │
└─────────────────────────────────────────────────────────────────┘
```

## 项目结构

```
CyscaleDB/
├── src/
│   ├── CyscaleDB.Core/              # 核心库
│   │   ├── Common/                  # 公共类型、常量、工具
│   │   │   ├── Constants.cs         # 全局常量
│   │   │   ├── DataType.cs          # 数据类型枚举
│   │   │   ├── DataValue.cs         # 数据值封装
│   │   │   ├── Exceptions.cs        # 异常定义
│   │   │   ├── Logging.cs           # 日志框架
│   │   │   └── Result.cs            # Result 类型
│   │   │
│   │   ├── Parsing/                 # SQL解析
│   │   │   ├── Lexer.cs             # 词法分析器
│   │   │   ├── Parser.cs            # 语法分析器
│   │   │   ├── Token.cs             # Token 定义
│   │   │   └── Ast/                 # AST节点定义
│   │   │       ├── AstNode.cs       # AST 基类
│   │   │       ├── Statements.cs    # 语句节点
│   │   │       └── Expressions.cs   # 表达式节点
│   │   │
│   │   ├── Execution/               # 查询执行
│   │   │   ├── Executor.cs          # 执行器
│   │   │   ├── ExecutionResult.cs   # 执行结果
│   │   │   ├── IOperator.cs         # 算子接口
│   │   │   ├── Operators/           # 算子实现
│   │   │   │   ├── TableScanOperator.cs
│   │   │   │   ├── IndexScanOperator.cs
│   │   │   │   ├── FilterOperator.cs
│   │   │   │   ├── ProjectOperator.cs
│   │   │   │   ├── NestedLoopJoinOperator.cs
│   │   │   │   ├── GroupByOperator.cs
│   │   │   │   ├── OrderByOperator.cs
│   │   │   │   ├── LimitOperator.cs
│   │   │   │   ├── DistinctOperator.cs
│   │   │   │   ├── AliasOperator.cs
│   │   │   │   └── DualOperator.cs
│   │   │   ├── Optimizer/           # 查询优化器
│   │   │   │   └── IndexSelector.cs
│   │   │   └── Expressions/         # 表达式求值
│   │   │       └── IExpressionEvaluator.cs
│   │   │
│   │   ├── Storage/                 # 存储引擎
│   │   │   ├── Page.cs              # 页面结构
│   │   │   ├── PageManager.cs       # 页面管理
│   │   │   ├── BufferPool.cs        # 缓冲池
│   │   │   ├── Table.cs             # 表操作
│   │   │   ├── Row.cs               # 行结构
│   │   │   ├── Catalog.cs           # 元数据管理
│   │   │   ├── DatabaseInfo.cs      # 数据库信息
│   │   │   ├── TableSchema.cs       # 表结构
│   │   │   ├── ColumnDefinition.cs  # 列定义
│   │   │   ├── ViewInfo.cs          # 视图元数据
│   │   │   ├── StorageEngine.cs     # 存储引擎
│   │   │   └── Index/               # 索引
│   │   │       ├── IndexInfo.cs     # 索引元数据
│   │   │       ├── BTreeIndex.cs    # B-Tree 索引
│   │   │       ├── BTreePage.cs     # B-Tree 页面
│   │   │       ├── HashIndex.cs     # Hash 索引
│   │   │       └── IndexManager.cs  # 索引管理器
│   │   │
│   │   ├── Transactions/            # 事务管理
│   │   │   ├── Transaction.cs       # 事务对象
│   │   │   ├── TransactionManager.cs # 事务管理器
│   │   │   ├── LockManager.cs       # 锁管理器
│   │   │   ├── WalLog.cs            # WAL日志
│   │   │   ├── WalArchiver.cs       # 日志归档
│   │   │   └── CheckpointManager.cs # 检查点管理
│   │   │
│   │   └── Protocol/                # MySQL协议
│   │       ├── MySqlServer.cs       # 协议服务器
│   │       ├── Handshake.cs         # 握手处理
│   │       ├── PacketReader.cs      # 包读取
│   │       └── PacketWriter.cs      # 包写入
│   │
│   ├── CyscaleDB.Server/            # 数据库服务器
│   │   └── Program.cs               # 服务器入口
│   │
│   └── CyscaleDB.Cli/               # 命令行工具
│       └── Program.cs               # CLI入口
│
└── tests/
    └── CyscaleDB.Tests/             # 测试项目
        ├── IntegrationTests/        # 集成测试
        └── ...                      # 单元测试
```

## 核心组件说明

### 1. 词法分析器 (Lexer)
- 将 SQL 字符串转换为 Token 流
- 识别关键字、标识符、字面量、运算符

### 2. 语法分析器 (Parser)
- 递归下降解析器
- 将 Token 流解析为 AST

### 3. 执行器 (Executor)
- 遍历 AST，构建执行计划
- 协调各个算子执行查询

### 4. 算子 (Operators)
- 迭代器模型 (Open/Next/Close)
- 每个算子处理特定操作

### 5. 存储引擎 (Storage Engine)
- 分页存储，每页 4KB
- LRU 缓冲池管理内存页
- 支持行的增删改查

### 6. 事务管理 (Transaction Manager)
- BEGIN/COMMIT/ROLLBACK 语义
- 表级锁实现并发控制
- WAL 日志保证持久性

### 7. MySQL协议 (MySQL Protocol)
- 实现 MySQL 客户端协议
- 支持标准 MySQL 客户端连接

### 8. 索引系统 (Index System)
- B-Tree 索引：支持等值和范围查询
- Hash 索引：高效等值查询
- 索引管理器：创建、删除、维护索引

### 9. 视图支持 (View Support)
- 视图定义存储在 DatabaseInfo 中
- 查询时展开视图为底层 SELECT 语句
- 支持 CREATE OR REPLACE 语法

### 10. 查询优化器 (Query Optimizer)
- IndexSelector：根据 WHERE 条件选择最优索引
- 评估索引匹配度和查询成本
- 支持复合索引的最左前缀匹配

### 11. 日志管理增强 (Log Management)
- WalLog：支持自动轮转
- WalArchiver：压缩归档旧日志
- CheckpointManager：定期检查点，快速恢复

## 数据流

```
SQL String
    │
    ▼
┌─────────┐
│  Lexer  │ ──▶ Token Stream
└─────────┘
    │
    ▼
┌─────────┐
│ Parser  │ ──▶ AST
└─────────┘
    │
    ▼
┌─────────┐
│Executor │ ──▶ Operator Tree
└─────────┘
    │
    ▼
┌─────────┐
│Operators│ ──▶ Row Stream
└─────────┘
    │
    ▼
┌─────────┐
│ Storage │ ──▶ Pages / Rows
└─────────┘
    │
    ▼
  Result
```

---

> 此文档描述了 CyscaleDB 的系统架构。在进行架构变更时请同步更新此文档。
